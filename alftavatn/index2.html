
<html>
   <head>
      <link href='http://fonts.googleapis.com/css?family=Roboto:100' rel='stylesheet' type='text/css'>

      <meta charset="UTF-8">
      <link rel="stylesheet" href="{{ static_url("styles/style.css") }}">

      <script type="text/javascript" src="{{ static_url("js/jquery/jquery.min.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/clickitem.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/sprite.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/json.js") }}"></script>
      <script type="text/javascript">

         // Canvas handling
         var FPS = 30;
         var SECONDS_BETWEEN_FRAMES = 1 / FPS * 1000;
         var g_GameObjectManager = null;
         var g_run = new Image();
         g_run.src = "{{static_url("data/run.png")}}";

         window.onload = init;
         function init()
         {
             new GameObjectManager().startupGameObjectManager();
         }

         $(document).ready(function(){
            // Websocket handling
            var ws = new WebSocket("ws://localhost:8000/websocket");
            ws.onopen = function() {
            };
            ws.onmessage = function (evt) {
               var res = evt.data;
               res = res.split('@');
               command = res[0];
               console.log(res[0] + ' ' + res[1]);

               // If the machine is sending a dialog, displays it
               if (command == 'dialog'){
                  $("#response").html($("#response").html() + "<br>" + res[1]);
               }
               // If a new field of view is received, updates the canvas
               // For now, all fields of views are receiving unregarding the player id
               else if (command == 'fov'){
                  // Looking for changes in the new version
                  //old_fov = $("#fov").html();
                  //new_fov = res[1];
                  var fov = $.ajax({type:"POST", url:"", data: {'fov': 'True', 'player_name':'player'}, async:false} ).responseText;
                  $("#fov").html(fov);
                  diff = JSON.parse(res[1]); //json_diff(old_fov, res[1]);

                  console.log('added:', diff[0]['player'], 'removed:', diff[1]['player']);
                  //First items that were added, then items deleted.

                  for (var each in diff[1]['player']){
                     imobj = diff[1]['player'][each];
                     console.log('removing', imobj);
                     if (imobj == g_GameObjectManager.selectedObject && diff[0]['player'].indexOf(imobj) == -1){
                        g_GameObjectManager.unselectObject();
                     }
                     console.log(Object.keys(g_GameObjectManager.applicationManager.sprites[imobj].shutdownVisualGameObject));
                     removeVisualGameObjectByName(imobj);
                  }

                  for (var each in diff[0]['player']){
                     imobj = diff[0]['player'][each];

                     // Retrieves position from fov in json
                     f = JSON.parse(fov);
                     x = f[imobj]['x'];
                     y = f[imobj]['y'];
                     w = f[imobj]['w'];
                     h = f[imobj]['h'];
                     var imname = $.ajax({type:"POST", url:"", data: {'get_image_path': imobj}, async:false} ).responseText;
                     var g_run2 = new Image();
                     g_run2.src = imname ;
                     g_GameObjectManager.applicationManager.sprites[imobj] = new VisualGameObject().startupVisualGameObject(imobj, g_run2, x, y, 1);
                  }
               }
               else if (command == 'change'){
                  $("#refreshmodel").click();
               }
            };

            // Retrieving data from model
            var html = get_objects();
            console.log(html);
            $('#objects').html(get_objects());
            $("span.object").click(function(){
               click_item($(this));
            });


            // Clicking on canvas
            var can = document.getElementById('viewport'),
                canLeft = can.offsetLeft,
                canTop = can.offsetTop;
            can.addEventListener('click', function(event) {
                var x = event.pageX - canLeft,
                    y = event.pageY - canTop;
                //console.log(g_GameObjectManager.pickingBufferContext2D.getImageData(x,y,1,1).data);
                //t = g_GameObjectManager.gameObjects[0];
                //t.isRunning = !t.isRunning;
                i = g_GameObjectManager.pickHitbox(x, y);
                g_GameObjectManager.selectObject(g_GameObjectManager.gameObjects[i].name);
                name = g_GameObjectManager.gameObjects[i].name;
                $('span.object').each(function(index){
                  if ($(this).data('object') == name){
                    click_item($(this));
                  }
                });

            },false);

         });
   </script>
   </head>


   <body>
      <h2>Alftavatn</h2>
      <div id="canvas"></div>
      <canvas id="viewport" width=900 height=300></canvas>
      <div id="fov">{}</div><br>

      <div id="objects" style="border:solid 1px black"> </div>
      <br>
      <div id="actions" style="border:solid 1px black"> </div>
      <br>
      <div id="adddialog" style="border:solid 1px black">add_dialog </div>
      <div id="toggledoor" style="border:solid 1px black">toggle_door </div>
      <div id="cleandata" style="border:solid 1px black">clean_data </div>
      <br>

<!-- Include model and rules view -->
      <br>
      <div id="jstwitter"></div>
      <span id="refreshmodel"> refresh</span>
      <div id="rules"></div>

    <br>
<br>
(c) GO 2013
<script>
</script>

</body></html>
