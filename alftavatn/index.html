<html>
   <head>
      <link href='http://fonts.googleapis.com/css?family=Roboto:100' rel='stylesheet' type='text/css'>

      <meta charset="UTF-8">
      <link rel="stylesheet" href="{{ static_url("styles/style.css") }}">
      <link rel="stylesheet" href="{{ static_url("styles/token-input.css") }}" type="text/css" />
      <link rel="stylesheet" href="{{ static_url("styles/token-input-facebook.css") }}" type="text/css" />

      <script type="text/javascript" src="{{ static_url("js/jquery.min.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/jquery.tokeninput.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/jquery.gridalicious.min.js") }}"></script>
      <script type="text/javascript" src="{{ static_url("js/clickitem.js") }}"></script>
      <script type="text/javascript">


         $(document).ready(function(){
            function make_base(images, image, x, y, w, h, canvas, context)
            {
                 images[image] = new Image();
                 console.log(image);
                 var res = $.ajax({type:"POST", url:"", data: {'get_image_path': image}, async:false} ).responseText;
                 console.log(res);
                 images[image].src = res;
                   images[image].onload = function(){
                     context.drawImage(images[image], x, y, w, h);
                   }
            }

            var ws = new WebSocket("ws://localhost:8000/websocket");

            ws.onopen = function() {
            };
            ws.onmessage = function (evt) {
               var res = evt.data;
               res = res.split('@');
               command = res[0];
               console.log(res[0] + ' ' + res[1]);
               if (command == 'dialog'){
                  $("#response").html($("#response").html() + "<br>" + res[1]);
               }
               else if (command == 'fov'){
                  $("#fov").html(res[1]);
                  $("#refreshcanvas").click();
               }
               else if (command == 'change'){
                  $("#refreshmodel").click();
               }
            };

            $("#rules").html("toto");
            $("input[type=button]#tokensubmit").click(function () {
               var items = $(this).siblings("input[type=text]").val();
               items = items.split(',');
               console.log(items);
               if (items.length == 2){
                  ws.send("DIALOG@"+items[0] +', '+items[1]);
                  ws.send('ACTION@'+ items[0]+','+ items[1]);
                  $("#demo-input").tokenInput("clear");
               }
            });
            $("input[type=button]#tokensubmit").keypress(function(event) {
                if (event.which == 13) {
                  event.preventDefault();
                  $("input[type=button]#tokensubmit").click();
                }
                else if (event.which == 9){
                  event.preventDefault();
                  $("#demo-input").tokenInput("focus");
                }
            });

            $('#refreshmodel').click(function(){

               var res = $.ajax({type:"POST", url:"", data: {'refreshmodel': 'True'}, async:false} ).responseText;
               $("#jstwitter").html(res);
               $("#jstwitter").gridalicious({
                  gutter: 13,
                     width: 151,
                     animate: true,
                     animationOptions: {
                        queue : true,
                        speed: 100,
                        duration: 100
                     }
               });
            });

            $('#refreshcanvas').click(function(){
               if ($("#fov").html().length > 0){
                  if (!("player" in JSON.parse($("#fov").html()))) {
                     return '';
                  }
                  //var j = JSON.parse($("#fov").html())['player'].toString();
                  var res = $.ajax({type:"POST", url:"", data: {'refreshcanvas': 'True'}, async:false} ).responseText;
                  $("#canvas").html(res);
                  $("#canvas").gridalicious({
                     gutter: 13,
                        width: 151,
                        animate: true,
                        animationOptions: {
                           queue : true,
                           speed: 500,
                           duration: 500
                        }
                  });
                  $("div.item").click(function(){
                     var obj = $(this).find('b').text();
                     ws.send("ACTION@" + obj + ",CLICK");
                  });
                  var fov = JSON.parse($("#fov").html())['player'];
                  var canvas = document.getElementById('viewport'),
                      context = canvas.getContext('2d');
                  var images = {};
                  context.imageSmoothingEnabled = false;
                  context.webkitImageSmoothingEnabled = false;
                  context.mozImageSmoothingEnabled = false;
                  context.clearRect(0, 0, canvas.width, canvas.height);
                  for (var obj in fov) {
                      if (fov.hasOwnProperty(obj)) {
                          var im = fov[obj]['image'];
                          var x = fov[obj]['x'];
                          var y = fov[obj]['y'];
                          var w = fov[obj]['w'];
                          var h = fov[obj]['h'];

                          make_base(images, im, x, y, w, h, canvas, context);
                      }
                  }

               }
            });

            var html = get_objects();
            $('#objects').html(html);

            $("span.object").click(function(){
               click_item($(this));
            });
            $("#adddialog").click(function(){
               ws.send("DIALOG@oh yeah c'est cool!");
            });
            $("#toggledoor").click(function(){
               ws.send('TOGGLEDOOR@');
            });
            $("#cleandata").click(function(){
               $("#response").html('');
            });

            $("#rules").html('{{rules}}');
            var res = $.ajax({type:"POST", url:"", data: {'fov': 'True'}, async:false} ).responseText;
            $("#fov").html(res);
            $("#refreshmodel").click();
            $("#refreshcanvas").click();


            $("#demo-input").tokenInput("list_tokens", {
                  tokenValue : 'name',
                     onAdd : function(item){
                        $(this).data("settings").url = 'list_tokens?object=' + $(this).tokenInput("get")[0].name;
                        $(this).data("settings").queryParam = 'qa';
                        $(this).data("settings").resultsFormatter = function(item){return "<li>"+item.name+"</li>";};
                  },
                  onDelete: function(item){
                        if (typeof(item) !== 'undefined' && item.type == 'object'){
                           $(this).tokenInput('clear');
                           $(this).data("settings").url = 'list_tokens'
                           $(this).data("settings").queryParam = 'q';
                           $(this).data("settings").resultsFormatter = function(item) {return tokenformat(item);};
                        }
                  },
                  resultsFormatter: function(item){ return tokenformat(item);},
                  theme: 'facebook'});


         });

      </script>
   </head>


   <body>
      <h2>Alftavatn</h2>
      <div id="canvas"></div>
      <canvas id="viewport" width=900 height=300></canvas>
      <span id="refreshcanvas"> refresh</span>

      <div id="fov"></div><br>
      <div id="response"></div> <br>
      <div>
      <input type="text" id="demo-input" name="blah" />
      <input id="tokensubmit" type="button" value="Submit" />
      </div>
      <br>

      <div id="objects" style="border:solid 1px black"> </div>
      <br>
      <div id="actions" style="border:solid 1px black"> </div>
      <br>
      <div id="adddialog" style="border:solid 1px black">add_dialog </div>
      <div id="toggledoor" style="border:solid 1px black">toggle_door </div>
      <div id="cleandata" style="border:solid 1px black">clean_data </div>
      <br>

<!-- Include model and rules view -->
      <br>
      <div id="jstwitter"></div>
      <span id="refreshmodel"> refresh</span>
      <div id="rules"></div>

    <br>
<br>
(c) GO 2013
<script>
</script>

</body></html>
